name: Build and Release PrusaSlicer

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

concurrency:
  group: prusa-slicer
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  get-tags:
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.latest_tag.outputs.latest_tag }}
      prusa_latest_tag: ${{ steps.prusa_latest_tag.outputs.prusa_latest_tag }}
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Get the latest release tag of this repository
      id: latest_tag
      run: |
        latest_tag=$(git describe --tags $(git rev-list --tags --max-count=1) 2> /dev/null || echo "v0.0.0" )
        echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT

    - name: Get the latest release tag of PrusaSlicer
      id: prusa_latest_tag
      run: |
        prusa_latest_tag=$(curl -s https://api.github.com/repos/prusa3d/PrusaSlicer/releases/latest | jq -r .tag_name)
        echo "prusa_latest_tag=$prusa_latest_tag" >> $GITHUB_OUTPUT

  build-deps:
    needs:
    - get-tags
    runs-on: ubuntu-latest
    if: needs.get-tags.outputs.latest_tag != needs.get-tags.outputs.prusa_latest_tag
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Clone PrusaSlicer at the latest tag
      env:
        prusa_latest_tag: ${{ needs.get-tags.outputs.prusa_latest_tag }}
      run: git clone --depth 1 --branch $prusa_latest_tag https://github.com/prusa3d/PrusaSlicer.git

    - name: Create "lockfile"
      run: find PrusaSlicer/deps -type f | sort | xargs sha256sum > deps.lock

    - uses: actions/cache@v4
      with:
        path: PrusaSlicer/deps/build
        key: deps-${{ hashFiles('deps.lock') }}

    - uses: ./.github/actions/apt

    - name: Replace GMP url
      run: sed -i 's|https://gmplib.org/download/gmp/gmp-6.2.1.tar.bz2|https://github.com/DevilPepper/PrusaSlicer/releases/download/gmp/gmp-6.2.1.tar.bz2|' PrusaSlicer/deps/+GMP/GMP.cmake

    - name: Replace Eigen hash
      run: sed -i 's|e09b89aae054e9778ee3f606192ee76d645eec82c402c01c648b1fe46b6b9857|4815118c085ff1d5a21f62218a3b2ac62555e9b8d7bacd5093892398e7a92c4b|' PrusaSlicer/deps/+Eigen/Eigen.cmake

    - name: Build dependencies
      run: |
        mkdir -p PrusaSlicer/deps/build
        cd PrusaSlicer/deps/build
        cmake .. -DDEP_WX_GTK3=ON
        make

  build:
    needs:
    - get-tags
    - build-deps
    runs-on: ubuntu-latest
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Clone PrusaSlicer at the latest tag
      env:
        prusa_latest_tag: ${{ needs.get-tags.outputs.prusa_latest_tag }}
      run: git clone --depth 1 --branch $prusa_latest_tag https://github.com/prusa3d/PrusaSlicer.git

    - name: Create "lockfile"
      run: find PrusaSlicer/deps -type f | sort | xargs sha256sum > deps.lock

    - uses: actions/cache/restore@v4
      with:
        path: PrusaSlicer/deps/build
        key: deps-${{ hashFiles('deps.lock') }}
        fail-on-cache-miss: true

    - uses: ./.github/actions/apt

    - name: Build PrusaSlicer
      run: |
        mkdir -p PrusaSlicer/build
        cd PrusaSlicer/build
        cmake .. -DSLIC3R_STATIC=1 -DSLIC3R_DESKTOP_INTEGRATION=0 -DSLIC3R_GTK=3 -DSLIC3R_PCH=OFF -DCMAKE_PREFIX_PATH=$(pwd)/../deps/build/destdir/usr/local
        make -j4

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prusa-artifacts
        path: |
          PrusaSlicer/build/src/prusa-slicer

  test:
    needs:
    - get-tags
    - build-deps
    runs-on: ubuntu-latest
    steps:
    - name: Checkout this repository
      uses: actions/checkout@v4

    - name: Clone PrusaSlicer at the latest tag
      env:
        prusa_latest_tag: ${{ needs.get-tags.outputs.prusa_latest_tag }}
      run: git clone --depth 1 --branch $prusa_latest_tag https://github.com/prusa3d/PrusaSlicer.git

    - name: Create "lockfile"
      run: find PrusaSlicer/deps -type f | sort | xargs sha256sum > deps.lock

    - uses: actions/cache/restore@v4
      with:
        path: PrusaSlicer/deps/build
        key: deps-${{ hashFiles('deps.lock') }}
        fail-on-cache-miss: true

    - uses: ./.github/actions/apt

    - name: Build PrusaSlicer
      run: |
        mkdir -p PrusaSlicer/build
        cd PrusaSlicer/build
        cmake .. -DCMAKE_BUILD_TYPE=Debug -DSLIC3R_STATIC=1 -DSLIC3R_DESKTOP_INTEGRATION=0 -DSLIC3R_GTK=3 -DSLIC3R_PCH=OFF -DCMAKE_PREFIX_PATH=$(pwd)/../deps/build/destdir/usr/local
        make -j4

    - name: Run tests
      run: |
        cd PrusaSlicer/build
        make test

  release:
    needs:
    - get-tags
    - build
    - test
    runs-on: ubuntu-latest
    steps:
    - name: Clone PrusaSlicer at the latest tag
      env:
        prusa_latest_tag: ${{ needs.get-tags.outputs.prusa_latest_tag }}
      run: git clone --depth 1 --branch $prusa_latest_tag https://github.com/prusa3d/PrusaSlicer.git

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: prusa-artifacts
        path: PrusaSlicer/build/src

    - name: Zip it
      run: |
        cd PrusaSlicer
        mkdir -p PrusaSlicer/bin
        cp -r src/platform/unix/*.desktop resources PrusaSlicer/
        cp build/src/prusa-slicer PrusaSlicer/bin/
        tar -cavf PrusaSlicer.tar.gz PrusaSlicer/

    - name: Create a release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ needs.get-tags.outputs.prusa_latest_tag }}
        release_name: PrusaSlicer ${{ needs.get-tags.outputs.prusa_latest_tag }}
        body: "Automated build of PrusaSlicer version ${{ needs.get-tags.outputs.prusa_latest_tag }}."
        draft: false
        prerelease: false
        files: PrusaSlicer/PrusaSlicer.tar.gz
